#!/bin/bash
# –ü–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è: —Å–æ–∑–¥–∞–Ω–∏–µ VPS —á–µ—Ä–µ–∑ API + –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

set -e

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

log_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

log_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

log_section() {
    echo -e "\n${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${CYAN}$1${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}\n"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
if ! command -v jq &> /dev/null; then
    log_warning "jq –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: brew install jq"
    log_info "–°–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é"
fi

log_section "üöÄ –ü–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ REG.RU"

# –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤
log_section "–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ REG.RU API"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
if [ ! -f ".env.regru.token" ] && [ -z "$REG_RU_API_TOKEN" ]; then
    log_error "–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

log_info "–ò—Å–ø–æ–ª—å–∑—É—è API –∫–ª–∏–µ–Ω—Ç –¥–ª—è REG.RU..."
log_info "–ü—Ä–æ–≤–µ—Ä—è—é –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –∏ –æ–±—Ä–∞–∑—ã..."

# –ò—Å–ø–æ–ª—å–∑—É–µ–º API –∫–ª–∏–µ–Ω—Ç
if [ -f "scripts/regru-api-client.sh" ]; then
    chmod +x scripts/regru-api-client.sh
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ API..."
    ./scripts/regru-api-client.sh check || log_warning "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
    
    log_info "–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤..."
    ./scripts/regru-api-client.sh tariffs | head -20 || log_warning "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–∞—Ä–∏—Ñ—ã"
    
    log_info "–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ–±—Ä–∞–∑–æ–≤..."
    ./scripts/regru-api-client.sh images | head -20 || log_warning "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–±—Ä–∞–∑—ã"
else
    log_warning "API –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–¥–æ–ª–∂–∞—é —Å —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π..."
fi

# –®–∞–≥ 2: –í–∞—Ä–∏–∞–Ω—Ç—ã –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è
log_section "–í–∞—Ä–∏–∞–Ω—Ç—ã –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è"

echo "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç:"
echo "1. VPS —É–∂–µ —Å–æ–∑–¥–∞–Ω - –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
echo "2. –°–æ–∑–¥–∞—Ç—å VPS —á–µ—Ä–µ–∑ API (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)"
echo "3. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä—É—á–Ω–æ–º—É —Å–æ–∑–¥–∞–Ω–∏—é VPS"
echo ""
read -p "–í–∞—à –≤—ã–±–æ—Ä [1-3]: " choice

case $choice in
    1)
        read -p "IP –∞–¥—Ä–µ—Å VPS: " VPS_IP
        read -p "SSH –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å [root]: " SSH_USER
        SSH_USER=${SSH_USER:-root}
        
        log_section "–ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
        ./scripts/auto-setup-regru.sh "$VPS_IP" "$SSH_USER"
        ;;
    2)
        log_info "–°–æ–∑–¥–∞–Ω–∏–µ VPS —á–µ—Ä–µ–∑ API..."
        log_warning "–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —Ç—Ä–µ–±—É–µ—Ç –æ–ø–ª–∞—Ç—ã!"
        
        read -p "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞: " SERVER_NAME
        read -p "ID —Ç–∞—Ä–∏—Ñ–∞: " TARIFF_ID
        read -p "ID –æ–±—Ä–∞–∑–∞ (–û–°): " IMAGE_ID
        
        log_warning "–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ —Ç—Ä–µ–±—É–µ—Ç –æ–ø–ª–∞—Ç—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (yes/no)"
        read -p "> " confirm
        if [ "$confirm" != "yes" ]; then
            log_info "–û—Ç–º–µ–Ω–µ–Ω–æ"
            exit 0
        fi
        
        if [ -f "scripts/regru-api-client.sh" ]; then
            log_info "–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ API..."
            SERVER_INFO=$(./scripts/regru-api-client.sh create-server "$SERVER_NAME" "$TARIFF_ID" "$IMAGE_ID")
            echo "$SERVER_INFO"
            
            # –ò–∑–≤–ª–µ—á—å IP –∏–∑ –æ—Ç–≤–µ—Ç–∞
            VPS_IP=$(echo "$SERVER_INFO" | jq -r '.server.ip // empty' 2>/dev/null || echo "")
            
            if [ -z "$VPS_IP" ]; then
                log_warning "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å IP –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
                read -p "–í–≤–µ–¥–∏—Ç–µ IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –≤—Ä—É—á–Ω—É—é: " VPS_IP
            else
                log_success "–°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–Ω! IP: $VPS_IP"
            fi
            
            log_info "–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞ (30 —Å–µ–∫—É–Ω–¥)..."
            sleep 30
            
            log_section "–ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
            ./scripts/auto-setup-regru.sh "$VPS_IP" "root"
        else
            log_error "API –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
        ;;
    3)
        log_section "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é VPS"
        echo "1. –ó–∞–π–¥–∏—Ç–µ –Ω–∞ https://reg.ru"
        echo "2. –û–±–ª–∞—á–Ω—ã–π VPS ‚Üí –ó–∞–∫–∞–∑–∞—Ç—å"
        echo "3. –í—ã–±–µ—Ä–∏—Ç–µ: Ubuntu 22.04, 2 vCPU, 2GB RAM"
        echo "4. –û–ø–ª–∞—Ç–∏—Ç–µ (~350-500‚ÇΩ/–º–µ—Å—è—Ü)"
        echo "5. –ó–∞–ø–∏—à–∏—Ç–µ IP –∞–¥—Ä–µ—Å"
        echo ""
        echo "–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ:"
        echo "  ./scripts/auto-setup-regru.sh YOUR_VPS_IP root"
        ;;
    *)
        log_error "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
        exit 1
        ;;
esac

log_success "–ì–æ—Ç–æ–≤–æ!"

