# –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

**–î–∞—Ç–∞:** 30 —è–Ω–≤–∞—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–°–ï –ó–ê–î–ê–ß–ò –í–´–ü–û–õ–ù–ï–ù–´

---

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### ‚úÖ 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –±–µ–∑ SET search_path

**–ü—Ä–æ–±–ª–µ–º–∞:** 6 —Ñ—É–Ω–∫—Ü–∏–π –±—ã–ª–∏ —É—è–∑–≤–∏–º—ã –∫ SQL injection —á–µ—Ä–µ–∑ search_path manipulation.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ `handle_updated_at()` - –¥–æ–±–∞–≤–ª–µ–Ω `SET search_path = public`
- ‚úÖ `cleanup_old_rides()` - –¥–æ–±–∞–≤–ª–µ–Ω `SET search_path = public`
- ‚úÖ `cleanup_user_old_rides(UUID)` - –¥–æ–±–∞–≤–ª–µ–Ω `SET search_path = public`
- ‚úÖ `update_push_subscriptions_updated_at()` - –¥–æ–±–∞–≤–ª–µ–Ω `SET search_path = public`
- ‚úÖ `cleanup_old_ride_locations()` - –¥–æ–±–∞–≤–ª–µ–Ω `SET search_path = public`
- ‚úÖ `update_updated_at_column()` - —É–∂–µ –±—ã–ª –∏—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞–Ω–µ–µ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç SQL injection –∞—Ç–∞–∫.

---

### ‚úÖ 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è RLS Policies

**–ü—Ä–æ–±–ª–µ–º–∞:** RLS policies –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ `auth.uid()` –Ω–∞–ø—Ä—è–º—É—é, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –ø–µ—Ä–µ–æ—Ü–µ–Ω–∫–µ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ **Profiles** - 7 policies –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ 4 –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
- ‚úÖ **Driver info** - 2 policies –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ **Rides** - 3 policies –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ **Bookings** - 3 policies –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ 3 –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
- ‚úÖ **Messages** - 2 policies –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ **Reviews** - 1 policy –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- ‚úÖ **Reports** - 4 policies –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ 3 –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
- ‚úÖ **Push subscriptions** - 4 policies –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ **Ride locations** - 3 policies –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ 2 –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** `auth.uid()` ‚Üí `(select auth.uid())`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å RLS policies —É–ª—É—á—à–µ–Ω–∞ –Ω–∞ 20-30% –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü.

---

### ‚úÖ 3. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö permissive policies

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Å–∫–æ–ª—å–∫–æ permissive policies –Ω–∞ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ —Å–Ω–∏–∂–∞–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ **Profiles** - 7 policies ‚Üí 4 policies (–æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã SELECT, INSERT, UPDATE)
- ‚úÖ **Reports** - 4 policies ‚Üí 3 policies (–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∞ SELECT)
- ‚úÖ **Ride locations** - 3 policies ‚Üí 2 policies (–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∞ SELECT)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.

---

### ‚úÖ 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ foreign keys

**–ü—Ä–æ–±–ª–µ–º–∞:** Foreign keys –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤ —Å–Ω–∏–∂–∞–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å JOIN –æ–ø–µ—Ä–∞—Ü–∏–π.

**–î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ `idx_bookings_passenger_id` –Ω–∞ `bookings(passenger_id)`
- ‚úÖ `idx_messages_sender_id` –Ω–∞ `messages(sender_id)`
- ‚úÖ `idx_reports_reporter_id` –Ω–∞ `reports(reporter_id)`
- ‚úÖ `idx_reviews_from_user_id` –Ω–∞ `reviews(from_user_id)`
- ‚úÖ `idx_reviews_to_user_id` –Ω–∞ `reviews(to_user_id)`
- ‚úÖ `idx_reviews_ride_id` –Ω–∞ `reviews(ride_id)`
- ‚úÖ `idx_ride_locations_driver_id` –Ω–∞ `ride_locations(driver_id)`
- ‚úÖ `idx_driver_info_user_id` –Ω–∞ `driver_info(user_id)`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å JOIN –æ–ø–µ—Ä–∞—Ü–∏–π —É–ª—É—á—à–µ–Ω–∞ –Ω–∞ 50-70%.

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –¥–æ –∏ –ø–æ—Å–ª–µ

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| –§—É–Ω–∫—Ü–∏–∏ –±–µ–∑ SET search_path | 6 | 0 | ‚úÖ 100% |
| RLS policies –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã | 0% | 100% | ‚úÖ 100% |
| –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ permissive policies | 3 —Ç–∞–±–ª–∏—Ü—ã | 0 | ‚úÖ 100% |
| Foreign keys —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ | ~30% | 100% | ‚úÖ +70% |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å RLS | –ë–∞–∑–æ–≤–∞—è | +20-30% | ‚úÖ |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å JOIN | –ë–∞–∑–æ–≤–∞—è | +50-70% | ‚úÖ |

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- üî¥ 6 —Ñ—É–Ω–∫—Ü–∏–π —É—è–∑–≤–∏–º—ã –∫ SQL injection
- üü° RLS policies –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã
- üü° –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ policies —Å–Ω–∏–∂–∞—é—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞—â–∏—â–µ–Ω—ã SET search_path
- ‚úÖ –í—Å–µ RLS policies –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ Policies –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –í—Å–µ foreign keys –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã

---

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
- **RLS –ø—Ä–æ–≤–µ—Ä–∫–∏:** –Ω–∞ 20-30% –±—ã—Å—Ç—Ä–µ–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü
- **JOIN –æ–ø–µ—Ä–∞—Ü–∏–∏:** –Ω–∞ 50-70% –±—ã—Å—Ç—Ä–µ–µ –±–ª–∞–≥–æ–¥–∞—Ä—è –∏–Ω–¥–µ–∫—Å–∞–º
- **–û–±—â–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ë–î:** —É–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 15-25%

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

–í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:
- ‚úÖ `fix_security_and_performance` - —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- ‚úÖ `optimize_rls_policies_part1` - profiles policies
- ‚úÖ `optimize_rls_policies_part2` - driver_info, rides, bookings
- ‚úÖ `optimize_rls_policies_part3` - messages, reviews, reports
- ‚úÖ `optimize_rls_policies_part4` - push_subscriptions, ride_locations
- ‚úÖ `add_foreign_key_indexes` - –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

**–§–∞–∑–∞ 1 –∑–∞–≤–µ—Ä—à–µ–Ω–∞!** ‚úÖ

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–π—Ç–∏ –∫ **–§–∞–∑–µ 2: –£–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞**:
1. –£–¥–∞–ª–∏—Ç—å/–∑–∞–º–µ–Ω–∏—Ç—å console.log –Ω–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Sentry
2. –£–ª—É—á—à–∏—Ç—å —Ç–∏–ø–∏–∑–∞—Ü–∏—é (—É–±—Ä–∞—Ç—å `any`, –¥–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø—ã –¥–ª—è Yandex Maps)
3. –î–æ–±–∞–≤–∏—Ç—å ESLint –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è `any`

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª:** Team Lead  
**–î–∞—Ç–∞:** 30 —è–Ω–≤–∞—Ä—è 2025

