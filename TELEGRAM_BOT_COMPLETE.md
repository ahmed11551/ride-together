# Telegram –±–æ—Ç - –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

### 1. API Endpoints –Ω–∞ –±—ç–∫–µ–Ω–¥–µ:
- ‚úÖ `POST /api/telegram/subscribe` - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –±–æ—Ç–∞
- ‚úÖ `POST /api/telegram/unsubscribe` - –æ—Ç–ø–∏—Å–∫–∞ –æ—Ç –±–æ—Ç–∞  
- ‚úÖ `GET /api/telegram/status` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏

### 2. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:
- ‚úÖ –•—É–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ (`useTelegramSubscription`)
- ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–æ–¥–ø–∏—Å–∫–∏ (`SubscribePrompt`)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç API –≤–º–µ—Å—Ç–æ Supabase

### 3. –ë–æ—Ç (Edge Function):
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ (`/start`, `/help`, etc.)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –∫–Ω–æ–ø–æ–∫
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ë–î
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ: Ride Together

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

### 1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –ë–î

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –º–∏–≥—Ä–∞—Ü–∏—é –∏–∑ `TIMEWEB_FULL_SCHEMA.sql`:
- `bot_users`
- `subscriptions`

### 2. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram

1. –ù–∞–π–¥–∏—Ç–µ [@BotFather](https://t.me/BotFather)
2. `/newbot`
3. –ò–º—è: `Ride Together Bot`
4. Username: `RideTogetherBot`
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω

### 3. –û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```bash
cd /var/www/ride-together/server
nano .env.production
```

–î–æ–±–∞–≤—å—Ç–µ:
```env
TELEGRAM_BOT_TOKEN=your_bot_token_here
```

–ò–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ `ecosystem.config.cjs`:
```javascript
env: {
  TELEGRAM_BOT_TOKEN: 'your_bot_token_here',
}
```

### 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

```bash
pm2 restart ride-backend --update-env
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

### –ü—Ä–æ–≤–µ—Ä–∫–∞ API:

```bash
# –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ (–Ω—É–∂–µ–Ω —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
curl -X GET https://api.ridetogether.ru/api/telegram/status \
  -H "Authorization: Bearer YOUR_USER_TOKEN"

# –ü–æ–¥–ø–∏—Å–∫–∞
curl -X POST https://api.ridetogether.ru/api/telegram/subscribe \
  -H "Authorization: Bearer YOUR_USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "telegram_user_id": 123456789,
    "telegram_username": "test_user",
    "telegram_first_name": "Test"
  }'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–æ—Ç–∞:

1. –ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞: `@RideTogetherBot`
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç
4. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é

## üì± –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `SubscribePrompt`
2. –ù–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –±–æ—Ç–∞"
3. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –±–æ—Ç –≤ Telegram
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/start`
5. –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:

1. **–í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å
   - –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
   - –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è" –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å

2. **–í –±–æ—Ç–µ:**
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start`
   - –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º
   - –ú–µ–Ω—é –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å

3. **–í –ë–î:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É `bot_users` - –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–ø–∏—Å—å
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É `subscriptions` - –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–¥–ø–∏—Å–∫–∞

## ‚ö†Ô∏è –í–∞–∂–Ω–æ:

1. **Webhook –¥–ª—è –±–æ—Ç–∞:** –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Supabase Edge Function, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ webhook —á–µ—Ä–µ–∑ BotFather
2. **APP_URL:** –û–±–Ω–æ–≤–∏—Ç–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω
3. **–¢–æ–∫–µ–Ω:** –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –≤ git

## üêõ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º:

### "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç":
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ API endpoint –¥–æ—Å—Ç—É–ø–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±—ç–∫–µ–Ω–¥–∞: `pm2 logs ride-backend`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω

### "–ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç":
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Edge Function (–µ—Å–ª–∏ —á–µ—Ä–µ–∑ Supabase)

### "–û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏":
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î

## üìã –ß–µ–∫–ª–∏—Å—Ç:

- [ ] –ë–æ—Ç —Å–æ–∑–¥–∞–Ω –≤ BotFather
- [ ] –¢–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –¢–∞–±–ª–∏—Ü—ã `bot_users` –∏ `subscriptions` —Å—É—â–µ—Å—Ç–≤—É—é—Ç
- [ ] API endpoints —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- [ ] –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- [ ] –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
- [ ] Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

