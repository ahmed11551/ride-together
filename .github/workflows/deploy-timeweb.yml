name: Deploy to Timeweb Cloud

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

env:
  NODE_VERSION: '20'

jobs:
  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð¿ÐµÑ€ÐµÐ´ Ð´ÐµÐ¿Ð»Ð¾ÐµÐ¼
  check-infrastructure:
    name: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹
    runs-on: ubuntu-latest
    steps:
      - name: Install twc CLI
        run: |
          pip install twc-cli
          twc --version
      
      - name: Configure twc
        run: |
          echo "${{ secrets.TIMEWEB_CLOUD_TOKEN }}" | twc auth --token-stdin || echo "${{ secrets.TIMEWEB_CLOUD_TOKEN }}" > /tmp/token && twc auth < /tmp/token
        env:
          TIMEWEB_CLOUD_TOKEN: ${{ secrets.TIMEWEB_CLOUD_TOKEN }}
      
      - name: Check database status
        run: |
          if [ -n "${{ secrets.TIMEWEB_DB_ID }}" ]; then
            twc database get "${{ secrets.TIMEWEB_DB_ID }}"
          else
            echo "âš ï¸ TIMEWEB_DB_ID Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÑŽ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ Ð‘Ð”"
          fi
      
      - name: Check balance
        run: |
          twc account finances
      
      - name: Check servers
        run: |
          twc server list || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð²"
      
      - name: Create backup before deploy
        if: github.event_name != 'workflow_dispatch' && secrets.TIMEWEB_DB_ID != ''
        run: |
          BACKUP_NAME="pre-deploy-$(date +%Y%m%d-%H%M%S)"
          twc database backup create "${{ secrets.TIMEWEB_DB_ID }}" --name "$BACKUP_NAME" || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð±ÑÐºÐ°Ð¿"
        continue-on-error: true

  # Ð”ÐµÐ¿Ð»Ð¾Ð¹ Backend
  deploy-backend:
    name: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Backend
    runs-on: ubuntu-latest
    needs: check-infrastructure
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: server/package-lock.json
      
      - name: Install dependencies
        working-directory: ./server
        run: npm ci
      
      - name: Build backend
        working-directory: ./server
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Check build
        working-directory: ./server
        run: |
          if [ -d "dist" ]; then
            echo "âœ… Backend ÑÐ¾Ð±Ñ€Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
            ls -la dist/
          else
            echo "âŒ Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ dist Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
            exit 1
          fi
      
      - name: Deploy to Timeweb (info)
        run: |
          echo "ðŸ“ Ð”Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ:"
          echo "   1. Timeweb App Platform Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº GitHub"
          echo "   2. ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð¿Ñ€Ð¸ push Ð² main"
          echo "   3. Build command: npm install && npm run build"
          echo "   4. Start command: npm start"
          echo ""
          echo "Ð˜Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ twc CLI Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ (Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸)"

  # Ð”ÐµÐ¿Ð»Ð¾Ð¹ Frontend
  deploy-frontend:
    name: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Frontend
    runs-on: ubuntu-latest
    needs: check-infrastructure
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create .env.production
        run: |
          cat > .env.production << EOF
          VITE_API_URL=${{ secrets.VITE_API_URL }}
          VITE_WS_URL=${{ secrets.VITE_WS_URL }}
          EOF
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_WS_URL: ${{ secrets.VITE_WS_URL }}
      
      - name: Build frontend
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Check build
        run: |
          if [ -d "dist" ]; then
            echo "âœ… Frontend ÑÐ¾Ð±Ñ€Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
            echo "Ð Ð°Ð·Ð¼ÐµÑ€ dist/: $(du -sh dist | cut -f1)"
          else
            echo "âŒ Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ dist Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
            exit 1
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/
          retention-days: 7
      
      - name: Deploy info
        run: |
          echo "ðŸ“ Ð”Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ:"
          echo "   1. Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ dist/ Ð² Timeweb Static Hosting"
          echo "   2. Ð˜Ð»Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ñ‡ÐµÑ€ÐµÐ· Timeweb App Platform"
          echo ""
          echo "ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹ Ð´Ð»Ñ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸"

  # ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¿Ð¾ÑÐ»Ðµ Ð´ÐµÐ¿Ð»Ð¾Ñ
  post-deploy-monitoring:
    name: ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¿Ð¾ÑÐ»Ðµ Ð´ÐµÐ¿Ð»Ð¾Ñ
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()
    steps:
      - name: Install twc CLI
        run: pip install twc-cli
      
      - name: Configure twc
        run: |
          echo "${{ secrets.TIMEWEB_CLOUD_TOKEN }}" | twc auth --token-stdin || echo "${{ secrets.TIMEWEB_CLOUD_TOKEN }}" > /tmp/token && twc auth < /tmp/token
      
      - name: Verify infrastructure
        run: |
          echo "ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð¿Ð¾ÑÐ»Ðµ Ð´ÐµÐ¿Ð»Ð¾Ñ..."
          
          if [ -n "${{ secrets.TIMEWEB_DB_ID }}" ]; then
            echo "Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…:"
            twc database get "${{ secrets.TIMEWEB_DB_ID }}" || echo "âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð‘Ð”"
          fi
          
          echo ""
          echo "Ð¡ÐµÑ€Ð²ÐµÑ€Ñ‹:"
          twc server list || echo "âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð²"
          
          echo ""
          echo "Ð‘Ð°Ð»Ð°Ð½Ñ:"
          twc account finances || echo "âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð±Ð°Ð»Ð°Ð½ÑÐ°"
        continue-on-error: true
