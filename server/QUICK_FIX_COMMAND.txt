# ============================================================
# –í–´–ü–û–õ–ù–ò–¢–ï –≠–¢–£ –ö–û–ú–ê–ù–î–£ –ù–ê –°–ï–†–í–ï–†–ï (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ):
# ============================================================

cd /var/www/ride-together/server && cat > fix-server.sh << 'EOFFIX'
#!/bin/bash
set -e
cd /var/www/ride-together/server
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞..."
pm2 stop ride-backend 2>/dev/null || true
pm2 delete ride-backend 2>/dev/null || true
sleep 2
PID=$(ss -tlnp 2>/dev/null | grep ":3001 " | grep -oP 'pid=\K\d+' | head -1 || echo "")
[ ! -z "$PID" ] && kill -9 $PID 2>/dev/null || true
sleep 1
echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ..."
cd dist && python3 << 'PYTHON'
import re
with open('index.js', 'r') as f: content = f.read()
content = re.sub(r'path\.join\(__dirname,', r'path.join(process.cwd(),', content)
with open('index.js', 'w') as f: f.write(content)
print("‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ")
PYTHON
cd ..
node --check dist/index.js && echo "‚úÖ OK" || echo "‚ö†Ô∏è –û—à–∏–±–∫–∏"
pm2 flush 2>/dev/null || true
echo "üöÄ –ó–∞–ø—É—Å–∫..."
pm2 start ecosystem.config.cjs
sleep 5
echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞..."
curl -s http://localhost:3001/health && echo "" || echo "‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
pm2 status
EOFFIX
chmod +x fix-server.sh && ./fix-server.sh

# ============================================================
# –ò–õ–ò –ü–†–û–°–¢–û –í–´–ü–û–õ–ù–ò–¢–ï –í–†–£–ß–ù–£–Æ:
# ============================================================

# cd /var/www/ride-together/server
# pm2 stop ride-backend
# pm2 delete ride-backend
# cd dist
# python3 << 'PYTHON'
# import re
# with open('index.js', 'r') as f: content = f.read()
# content = re.sub(r'path\.join\(__dirname,', r'path.join(process.cwd(),', content)
# with open('index.js', 'w') as f: f.write(content)
# print("‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ")
# PYTHON
# cd ..
# node --check dist/index.js
# pm2 start ecosystem.config.cjs
# sleep 3
# curl http://localhost:3001/health

