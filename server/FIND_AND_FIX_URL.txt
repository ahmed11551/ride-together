# ============================================
# –ù–ê–ô–¢–ò –ò –ò–°–ü–†–ê–í–ò–¢–¨ –ü–†–û–ë–õ–ï–ú–£
# –í—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
# ============================================

cd /var/www/ride-together/server

# –®–∞–≥ 1: –ù–∞–π—Ç–∏ –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è new URL
echo "üîç –ò—â–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ new URL:"
grep -n "new URL\|searchParams" dist/api/rides/list.js

echo ""
echo "üîç –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –≤–æ–∫—Ä—É–≥ –æ—à–∏–±–∫–∏ (—Å—Ç—Ä–æ–∫–∞ 12):"
sed -n '8,20p' dist/api/rides/list.js

echo ""
echo "üîç –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Å—å —Ñ–∞–π–ª (–ø–µ—Ä–≤—ã–µ 30 —Å—Ç—Ä–æ–∫):"
head -30 dist/api/rides/list.js

# –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–∏–º –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ sed –∏ Python
echo ""
echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º..."

# –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª–∏–º —Å—Ç—Ä–æ–∫–∏ —Å new URL –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ
sed -i '/new URL(req\.url)/d' dist/api/rides/list.js
sed -i '/const url = new URL/d' dist/api/rides/list.js
sed -i '/let url = new URL/d' dist/api/rides/list.js
sed -i '/var url = new URL/d' dist/api/rides/list.js

# –¢–µ–ø–µ—Ä—å –∏—Å–ø—Ä–∞–≤–∏–º —á–µ—Ä–µ–∑ Python –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ
python3 << 'EOF'
import re

filepath = 'dist/api/rides/list.js'

with open(filepath, 'r', encoding='utf-8') as f:
    lines = f.readlines()

new_lines = []
modified = False

for i, line in enumerate(lines):
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å new URL
    if 'new URL' in line and 'req.url' in line:
        print(f"–£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É {i+1}: {line.strip()}")
        modified = True
        continue
    
    # –ó–∞–º–µ–Ω—è–µ–º url.searchParams –Ω–∞ req.query
    if 'url.searchParams' in line:
        print(f"–ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É {i+1}: {line.strip()}")
        # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
        line = line.replace('url.searchParams.get', 'req.query')
        line = line.replace('url.searchParams', 'req.query')
        # –£–±–∏—Ä–∞–µ–º .get( –∏ –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ –ø—Ä—è–º—É—é —Ç–æ—á–∫—É
        line = re.sub(r"req\.query\(['\"](\w+)['\"]\)", r"req.query.\1", line)
        line = re.sub(r'req\.query\(["\'](\w+)["\']\)', r"req.query.\1", line)
        modified = True
    
    new_lines.append(line)

if modified:
    with open(filepath, 'w', encoding='utf-8') as f:
        f.writelines(new_lines)
    print("‚úÖ –§–∞–π–ª –∏—Å–ø—Ä–∞–≤–ª–µ–Ω")
else:
    print("‚ö†Ô∏è  –§–∞–π–ª –Ω–µ –∏–∑–º–µ–Ω–µ–Ω")
    
    # –ü–æ–∫–∞–∂–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
    print("\nüìã –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å 'url':")
    for i, line in enumerate(lines):
        if 'url' in line.lower():
            print(f"{i+1}: {line.strip()}")
EOF

pm2 restart ride-backend
sleep 3
pm2 logs ride-backend --err --lines 10 --nostream

